{% extends "base.html" %}
{% block content %}
<h1>Reservar Cancha</h1>
<form method="POST" action="{{ url_for('reserve') }}">
    {{ form.hidden_tag() }}
    <div class="form-group">
        {{ form.date.label(class="form-label") }}
        {{ form.date(class="form-control", id="date") }}
    </div>
    <div class="form-group">
        {{ form.start_time.label(class="form-label") }}
        {{ form.start_time(class="form-control", id="start_time") }}
    </div>
    <div class="form-group">
        {{ form.use_type.label(class="form-label") }}
        {{ form.use_type(class="form-control", id="use_type") }}
    </div>
    <div class="form-group" id="game_type_div" style="display: none;">
        {{ form.game_type.label(class="form-label") }}
        {{ form.game_type(class="form-control", id="game_type") }}
    </div>
    <div class="form-group" id="league_category_div" style="display: none;">
        {{ form.league_category.label(class="form-label") }}
        {{ form.league_category(class="form-control") }}
    </div>
    <div class="form-group" id="elite_category_div" style="display: none;">
        {{ form.elite_category.label(class="form-label") }}
        {{ form.elite_category(class="form-control") }}
    </div>
    <div class="form-group" id="academy_category_div" style="display: none;">
        {{ form.academy_category.label(class="form-label") }}
        {{ form.academy_category(class="form-control") }}
    </div>
    <div id="players_div" style="display: none;">
        <div class="form-group">
            {{ form.player1.label(class="form-label") }}
            {{ form.player1(class="form-control", value=current_user.username) }}
        </div>
        <div class="form-group">
            {{ form.player1_is_member.label(class="form-check-label") }}
            {{ form.player1_is_member(class="form-check-input") }}
        </div>
        
        <div class="form-group" id="player2_div">
            {{ form.player2.label(class="form-label") }}
            {{ form.player2(class="form-control") }}
        </div>
        <div class="form-group" id="player2_is_member_div">
            {{ form.player2_is_member.label(class="form-check-label") }}
            {{ form.player2_is_member(class="form-check-input") }}
        </div>
        <div class="form-group" id="player3_div" style="display: none;">
            {{ form.player3.label(class="form-label") }}
            {{ form.player3(class="form-control") }}
        </div>
        <div class="form-group" id="player3_is_member_div" style="display: none;">
            {{ form.player3_is_member.label(class="form-check-label") }}
            {{ form.player3_is_member(class="form-check-input") }}
        </div>
        <div class="form-group" id="player4_div" style="display: none;">
            {{ form.player4.label(class="form-label") }}
            {{ form.player4(class="form-control") }}
        </div>
        <div class="form-group" id="player4_is_member_div" style="display: none;">
            {{ form.player4_is_member.label(class="form-check-label") }}
            {{ form.player4_is_member(class="form-check-input") }}
        </div>
    </div>
    <div class="form-group" id="trainer_div" style="display: none;">
        {{ form.trainer.label(class="form-label") }}
        {{ form.trainer(class="form-control") }}
    </div>
    <div class="form-group">
        {{ form.court_id.label(class="form-label") }}
        <select id="court_id" name="court_id" class="form-control">
            <option value="">Selecciona una cancha</option>
        </select>
    </div>
    <div class="form-group">
        {{ form.is_paid.label(class="form-check-label") }}
        {{ form.is_paid(class="form-check-input") }}
    </div>
    <div class="form-group">
        {{ form.payment_amount.label(class="form-label") }}
        {{ form.payment_amount(class="form-control") }}
    </div>
    <div class="form-group">
        {{ form.comments.label(class="form-label") }}
        {{ form.comments(class="form-control") }}
    </div>
    <button type="submit" class="btn btn-primary">Reservar</button>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var dateField = document.getElementById('date');
    var timeField = document.getElementById('start_time');
    var useTypeField = document.getElementById('use_type');
    var courtField = document.getElementById('court_id');
    var gameTypeDiv = document.getElementById('game_type_div');
    var leagueCategoryDiv = document.getElementById('league_category_div');
    var eliteCategoryDiv = document.getElementById('elite_category_div');
    var academyCategoryDiv = document.getElementById('academy_category_div');
    var playersDiv = document.getElementById('players_div');
    var trainerDiv = document.getElementById('trainer_div');
    var player2Div = document.getElementById('player2_div');
    var player2IsMemberDiv = document.getElementById('player2_is_member_div');
    var player3Div = document.getElementById('player3_div');
    var player3IsMemberDiv = document.getElementById('player3_is_member_div');
    var player4Div = document.getElementById('player4_div');
    var player4IsMemberDiv = document.getElementById('player4_is_member_div');
    var gameTypeField = document.getElementById('game_type');

    function updateAvailableCourts() {
        var date = dateField.value;
        var time = timeField.value;
        var useType = useTypeField.value;

        if (date && time && useType) {
            fetch(`/get_available_courts?date=${date}&start_time=${time}&use_type=${useType}`)
                .then(response => response.json())
                .then(courts => {
                    console.log('Canchas recibidas:', courts);  // Agregar esta línea para depuración
                    courtField.innerHTML = '';
                    if (courts.length === 0) {
                        var option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'No hay canchas disponibles';
                        courtField.appendChild(option);
                    } else {
                        courts.forEach(court => {
                            var option = document.createElement('option');
                            option.value = court.id;
                            option.textContent = court.name;
                            courtField.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error al obtener las canchas:', error);
                });
        }
    }

    function updateFormFields() {
        var useType = useTypeField.value;
        console.log('Tipo de uso seleccionado:', useType);  // Agregar para depuración

        gameTypeDiv.style.display = (useType === 'amistoso' || useType === 'liga') ? 'block' : 'none';
        leagueCategoryDiv.style.display = useType === 'liga' ? 'block' : 'none';
        eliteCategoryDiv.style.display = useType === 'elite' ? 'block' : 'none';
        academyCategoryDiv.style.display = useType === 'academia_interna' ? 'block' : 'none';
        playersDiv.style.display = (useType === 'amistoso' || useType === 'liga' || useType === 'entrenamiento_individual' || useType === 'entrenamiento_grupal') ? 'block' : 'none';
        trainerDiv.style.display = (useType === 'entrenamiento_individual' || useType === 'entrenamiento_grupal') ? 'block' : 'none';

        if (useType === 'amistoso' || useType === 'liga') {
            var gameType = gameTypeField.value;
            console.log('Tipo de juego seleccionado:', gameType);  // Agregar para depuración
            player2Div.style.display = 'block';
            player2IsMemberDiv.style.display = 'block';
            player3Div.style.display = gameType === 'dobles' ? 'block' : 'none';
            player3IsMemberDiv.style.display = gameType === 'dobles' ? 'block' : 'none';
            player4Div.style.display = gameType === 'dobles' ? 'block' : 'none';
            player4IsMemberDiv.style.display = gameType === 'dobles' ? 'block' : 'none';
        } else if (useType === 'entrenamiento_individual') {
            player2Div.style.display = 'block';
            player2IsMemberDiv.style.display = 'block';
            player3Div.style.display = 'none';
            player3IsMemberDiv.style.display = 'none';
            player4Div.style.display = 'none';
            player4IsMemberDiv.style.display = 'none';
        } else if (useType === 'entrenamiento_grupal') {
            player2Div.style.display = 'block';
            player2IsMemberDiv.style.display = 'block';
            player3Div.style.display = 'block';
            player3IsMemberDiv.style.display = 'block';
            player4Div.style.display = 'block';
            player4IsMemberDiv.style.display = 'block';
        } else {
            player2Div.style.display = 'none';
            player2IsMemberDiv.style.display = 'none';
            player3Div.style.display = 'none';
            player3IsMemberDiv.style.display = 'none';
            player4Div.style.display = 'none';
            player4IsMemberDiv.style.display = 'none';
        }
    }

    dateField.addEventListener('change', updateAvailableCourts);
    timeField.addEventListener('change', updateAvailableCourts);
    useTypeField.addEventListener('change', function() {
        updateAvailableCourts();
        updateFormFields();
    });
    gameTypeField.addEventListener('change', updateFormFields);

    // Inicializar los campos del formulario
    updateFormFields();
});
</script>

{% endblock %}
